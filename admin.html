<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yellow Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      min-height: 100vh;
      background: #1a1a1a;
      font-family: Arial, sans-serif;
      color: #fff;
      padding: 20px;
    }

    /* LOGIN */
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      text-align: center;
    }

    .login-container h1 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 48px;
      color: #E8A000;
      margin-bottom: 30px;
    }

    .login-container input {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      border: 2px solid #E8A000;
      background: transparent;
      color: #fff;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .login-container button {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      background: #E8A000;
      color: #1a1a1a;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    /* DASHBOARD */
    .dashboard {
      display: none;
      max-width: 1200px;
      margin: 0 auto;
    }

    .dashboard.visible {
      display: block;
    }

    .dashboard h1 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 48px;
      color: #E8A000;
      margin-bottom: 30px;
    }

    /* STATS CARDS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: #2a2a2a;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid #3a3a3a;
    }

    .stat-card .number {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 48px;
      color: #E8A000;
    }

    .stat-card .label {
      font-size: 14px;
      color: #888;
      margin-top: 5px;
    }

    .stat-card.banned .number {
      color: #ff4444;
    }

    /* SECTIONS */
    .section {
      background: #2a2a2a;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .section h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 24px;
      color: #E8A000;
      margin-bottom: 20px;
    }

    /* TABS */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 10px 20px;
      background: #3a3a3a;
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
    }

    .tab-btn:hover, .tab-btn.active {
      background: #E8A000;
      color: #1a1a1a;
    }

    /* USER LIST */
    .user-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .user-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px;
      border-bottom: 1px solid #3a3a3a;
      cursor: pointer;
      transition: background 0.2s;
    }

    .user-item:hover {
      background: #3a3a3a;
    }

    .user-item:last-child {
      border-bottom: none;
    }

    .user-item img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    .user-item .username {
      font-weight: bold;
      color: #E8A000;
    }

    .user-item .meta {
      font-size: 12px;
      color: #888;
    }

    .user-item.banned {
      opacity: 0.5;
      background: rgba(255, 68, 68, 0.1);
    }

    .user-item.banned .username {
      color: #ff4444;
      text-decoration: line-through;
    }

    /* SEARCH */
    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .search-box input {
      flex: 1;
      padding: 12px;
      background: #3a3a3a;
      border: none;
      border-radius: 6px;
      color: #fff;
      font-size: 14px;
    }

    .search-box button {
      padding: 12px 20px;
      background: #E8A000;
      border: none;
      border-radius: 6px;
      color: #1a1a1a;
      cursor: pointer;
      font-weight: bold;
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.open {
      display: flex;
    }

    .modal-content {
      background: #2a2a2a;
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h3 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 28px;
      color: #E8A000;
    }

    .close-btn {
      background: none;
      border: none;
      color: #888;
      font-size: 24px;
      cursor: pointer;
    }

    .close-btn:hover {
      color: #fff;
    }

    /* USER DETAIL */
    .user-detail {
      text-align: center;
      margin-bottom: 20px;
    }

    .user-detail img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin-bottom: 10px;
    }

    .user-detail .username {
      font-size: 24px;
      color: #E8A000;
      font-weight: bold;
    }

    .user-detail .user-id {
      font-size: 12px;
      color: #666;
    }

    /* BADGES GRID */
    .badges-manage {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin: 20px 0;
    }

    .badge-item {
      aspect-ratio: 1;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      padding: 5px;
    }

    .badge-item.locked {
      background: #3a3a3a;
      border: 2px solid #555;
      color: #666;
    }

    .badge-item.unlocked {
      background: #E8A000;
      border: 2px solid #8B5A00;
      color: #000;
    }

    .badge-item:hover {
      transform: scale(1.1);
    }

    /* ACTION BUTTONS */
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }

    .btn-danger {
      background: #ff4444;
      color: #fff;
    }

    .btn-success {
      background: #00c853;
      color: #fff;
    }

    .btn-warning {
      background: #E8A000;
      color: #1a1a1a;
    }

    /* FILTER */
    .filter-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-row select, .filter-row input {
      padding: 10px;
      background: #3a3a3a;
      border: none;
      border-radius: 6px;
      color: #fff;
      font-size: 14px;
    }

    /* LOGOUT */
    .logout-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      background: #3a3a3a;
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
    }

    .logout-btn:hover {
      background: #E8A000;
      color: #1a1a1a;
    }

    .error {
      color: #ff4444;
      margin-top: 10px;
    }

    .success {
      color: #00c853;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="login-container" id="loginContainer">
  <h1>üîí YELLOW ADMIN</h1>
  <input type="password" id="passwordInput" placeholder="Enter admin password">
  <button onclick="login()">Access Dashboard</button>
  <p class="error" id="loginError"></p>
</div>

<!-- DASHBOARD -->
<div class="dashboard" id="dashboard">
  <button class="logout-btn" onclick="logout()">Logout</button>
  
  <h1>üê± YELLOW ADMIN DASHBOARD</h1>

  <!-- STATS CARDS -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="number" id="totalUsers">-</div>
      <div class="label">Total Users</div>
    </div>
    <div class="stat-card">
      <div class="number" id="ogBadges">-</div>
      <div class="label">OG Badges</div>
    </div>
    <div class="stat-card">
      <div class="number" id="totalBadges">-</div>
      <div class="label">Badges Given</div>
    </div>
    <div class="stat-card banned">
      <div class="number" id="bannedCount">-</div>
      <div class="label">Banned</div>
    </div>
  </div>

  <!-- SEARCH USER -->
  <div class="section">
    <h2>üîç Search User</h2>
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Enter username (e.g. Yellowcatz_)">
      <button onclick="searchUser()">Search</button>
    </div>
    <div class="user-list" id="searchResults"></div>
  </div>

  <!-- BADGE STATS -->
  <div class="section">
    <h2>üìä Badges Distribution</h2>
    <div id="badgeStats"></div>
  </div>

  <!-- USERS BY BADGE -->
  <div class="section">
    <h2>üë• Users by Badge</h2>
    <div class="filter-row">
      <select id="badgeSelect" onchange="loadUsersByBadge()">
        <option value="og">OG</option>
        <option value="badge_2">Badge 2 - Supporter</option>
        <option value="badge_3">Badge 3 - Yellow Army</option>
        <option value="badge_4">Badge 4 - Reach the Moon</option>
        <option value="badge_5">Badge 5 - X Hunter</option>
        <option value="badge_6">Badge 6 - M Hunter</option>
        <option value="badge_7">Badge 7 - ???</option>
        <option value="badge_8">Badge 8 - ???</option>
        <option value="badge_9">Badge 9 - ???</option>
        <option value="badge_10">Badge 10 - ???</option>
      </select>
    </div>
    <div class="user-list" id="usersByBadge"></div>
  </div>

<!-- USERS BY BADGE COUNT + EXPORT -->
<div class="section">
  <h2>üéØ Users by Badge Count</h2>

  <div class="filter-row">
    <select id="badgeCountMode">
      <option value="exact">Exactly</option>
      <option value="min">At least</option>
    </select>

    <select id="badgeCountValue">
      <option value="1">1 badge</option>
      <option value="3">3 badges</option>
      <option value="4">4 badges</option>
      <option value="6">6 badges</option>
      <option value="8">8 badges</option>
      <option value="10">10 badges</option>
    </select>

    <button class="btn btn-warning" onclick="loadUsersByBadgeCount()">
      Search
    </button>

    <button class="btn btn-success" onclick="exportUsersByBadgeCountCSV()">
      Export CSV
    </button>
  </div>

  <div class="user-list" id="usersByBadgeCount"></div>
</div>

  <!-- BANNED USERS -->
  <div class="section">
    <h2>üö´ Banned Users</h2>
    <div class="user-list" id="bannedUsers"></div>
  </div>

  <!-- RECENT USERS -->
  <div class="section">
    <h2>üïê Recent Users</h2>
    <div class="user-list" id="recentUsers"></div>
  </div>
</div>

<!-- USER MODAL -->
<div class="modal" id="userModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>User Details</h3>
      <button class="close-btn" onclick="closeModal()">&times;</button>
    </div>
    
    <div class="user-detail" id="modalUserDetail">
      <!-- Filled by JS -->
    </div>

    <h4 style="color:#E8A000; margin-bottom:10px;">Badges (click to toggle)</h4>
    <div class="badges-manage" id="modalBadges">
      <!-- Filled by JS -->
    </div>

    <div class="action-buttons">
      <button class="btn btn-danger" id="banBtn" onclick="toggleBan()">Ban User</button>
    </div>

    <p id="modalMessage"></p>
  </div>
</div>

<script>
let adminPassword = '';
let currentUserId = null;
let currentUserBanned = false;

// ============================================================
// AUTH
// ============================================================
async function login() {
  const password = document.getElementById('passwordInput').value;
  
  try {
    const res = await fetch('/api/admin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password, action: 'stats' })
    });

    if (!res.ok) {
      document.getElementById('loginError').textContent = 'Invalid password';
      return;
    }

    adminPassword = password;
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('dashboard').classList.add('visible');
    
    loadDashboard();
  } catch (err) {
    document.getElementById('loginError').textContent = 'Connection error';
  }
}

function logout() {
  adminPassword = '';
  document.getElementById('loginContainer').style.display = 'block';
  document.getElementById('dashboard').classList.remove('visible');
  document.getElementById('passwordInput').value = '';
}

// ============================================================
// API CALL
// ============================================================
async function apiCall(action, extraData = {}) {
  const res = await fetch('/api/admin', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: adminPassword, action, ...extraData })
  });
  return res.json();
}

// ============================================================
// DASHBOARD
// ============================================================
async function loadDashboard() {
  const data = await apiCall('stats');
  
  document.getElementById('totalUsers').textContent = data.totalUsers || 0;
  document.getElementById('bannedCount').textContent = data.bannedUsers || 0;
  
  // Badge stats
  let ogCount = 0;
  let totalBadges = 0;
  let badgeHTML = '<div style="display:flex;flex-wrap:wrap;gap:15px;">';
  
  if (data.badgeStats) {
    data.badgeStats.forEach(b => {
      totalBadges += Number(b.count);
      if (b.badge_id === 'og') ogCount = b.count;
      badgeHTML += `
        <div style="background:#3a3a3a;padding:10px 15px;border-radius:6px;">
          <strong style="color:#E8A000">${b.badge_id.toUpperCase()}</strong>: ${b.count}
        </div>
      `;
    });
  }
  badgeHTML += '</div>';
  
  document.getElementById('ogBadges').textContent = ogCount;
  document.getElementById('totalBadges').textContent = totalBadges;
  document.getElementById('badgeStats').innerHTML = badgeHTML;
  
  // Recent users
  renderUserList('recentUsers', data.recentUsers || []);
  
  // Load other sections
  loadUsersByBadge();
  loadBannedUsers();
}

// ============================================================
// RENDER USER LIST
// ============================================================
function renderUserList(containerId, users) {
  const container = document.getElementById(containerId);
  
  if (!users || users.length === 0) {
    container.innerHTML = '<p style="color:#666;padding:10px;">No users found</p>';
    return;
  }

  let html = '';
  users.forEach(u => {
    const bannedClass = u.is_banned ? 'banned' : '';
    html += `
      <div class="user-item ${bannedClass}" onclick="openUserModal(${u.id})">
        <img src="${u.avatar_url || 'https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png'}">
        <div>
          <div class="username">@${u.x_username}</div>
          <div class="meta">ID: ${u.id} ${u.is_banned ? '‚Ä¢ BANNED' : ''}</div>
        </div>
      </div>
    `;
  });
  container.innerHTML = html;
}

// ============================================================
// SEARCH
// ============================================================
async function searchUser() {
  const username = document.getElementById('searchInput').value.trim();
  if (!username) return;

  const data = await apiCall('searchUser', { username });
  renderUserList('searchResults', data.users || []);
}

// ============================================================
// USERS BY BADGE
// ============================================================
async function loadUsersByBadge() {
  const badgeId = document.getElementById('badgeSelect').value;
  const data = await apiCall('usersByBadge', { badgeId });
  renderUserList('usersByBadge', data.users || []);
}

// ============================================================
// BANNED USERS
// ============================================================
async function loadBannedUsers() {
  const data = await apiCall('bannedUsers');
  renderUserList('bannedUsers', data.users || []);
}

// ============================================================
// USER MODAL
// ============================================================
async function openUserModal(userId) {
  currentUserId = userId;
  const data = await apiCall('userDetails', { userId });
  
  if (!data.user) {
    alert('User not found');
    return;
  }

  currentUserBanned = data.user.is_banned === 1;
  
  // User detail
  document.getElementById('modalUserDetail').innerHTML = `
    <img src="${data.user.avatar_url || 'https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png'}">
    <div class="username">@${data.user.x_username}</div>
    <div class="user-id">ID: ${data.user.id} ‚Ä¢ Joined: ${new Date(data.user.created_at).toLocaleDateString()}</div>
    ${currentUserBanned ? '<div style="color:#ff4444;margin-top:10px;">‚õî BANNED</div>' : ''}
  `;

  // Badges
  const userBadgeIds = (data.userBadges || []).map(b => b.badge_id);
  let badgesHTML = '';
  
  (data.allBadges || []).forEach(b => {
    const unlocked = userBadgeIds.includes(b.badge_id);
    const cls = unlocked ? 'unlocked' : 'locked';
    badgesHTML += `
      <div class="badge-item ${cls}" onclick="toggleBadge('${b.badge_id}', ${unlocked})">
        ${b.badge_name}
      </div>
    `;
  });
  document.getElementById('modalBadges').innerHTML = badgesHTML;

  // Ban button
  const banBtn = document.getElementById('banBtn');
  if (currentUserBanned) {
    banBtn.textContent = 'Unban User';
    banBtn.className = 'btn btn-success';
  } else {
    banBtn.textContent = 'Ban User';
    banBtn.className = 'btn btn-danger';
  }

  document.getElementById('modalMessage').textContent = '';
  document.getElementById('userModal').classList.add('open');
}

function closeModal() {
  document.getElementById('userModal').classList.remove('open');
  currentUserId = null;
}

// ============================================================
// TOGGLE BADGE
// ============================================================
async function toggleBadge(badgeId, currentlyUnlocked) {
  if (!currentUserId) return;

  const action = currentlyUnlocked ? 'removeBadge' : 'addBadge';
  const data = await apiCall(action, { userId: currentUserId, badgeId });

  if (data.success) {
    document.getElementById('modalMessage').innerHTML = `<span class="success">${data.message}</span>`;
    // Refresh modal
    openUserModal(currentUserId);
    // Refresh dashboard
    loadDashboard();
  } else {
    document.getElementById('modalMessage').innerHTML = `<span class="error">${data.error || 'Error'}</span>`;
  }
}

// ============================================================
// TOGGLE BAN
// ============================================================
async function toggleBan() {
  if (!currentUserId) return;
  
  const action = currentUserBanned ? 'unbanUser' : 'banUser';
  const confirmMsg = currentUserBanned 
    ? 'Unban this user?' 
    : 'Ban this user? They will not be able to access the site.';
  
  if (!confirm(confirmMsg)) return;

  const data = await apiCall(action, { userId: currentUserId });

  if (data.success) {
    document.getElementById('modalMessage').innerHTML = `<span class="success">${data.message}</span>`;
    // Refresh
    openUserModal(currentUserId);
    loadDashboard();
    loadBannedUsers();
  } else {
    document.getElementById('modalMessage').innerHTML = `<span class="error">${data.error || 'Error'}</span>`;
  }
}

// Enter key to login
document.getElementById('passwordInput').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') login();
});

// Enter key to search
document.getElementById('searchInput').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') searchUser();
});

// Close modal on outside click
document.getElementById('userModal').addEventListener('click', (e) => {
  if (e.target.id === 'userModal') closeModal();
});

// ============================================================
// USERS BY BADGE COUNT + CSV EXPORT
// ============================================================

let usersByBadgeCountCache = [];

async function loadUsersByBadgeCount() {
  const mode = document.getElementById('badgeCountMode').value;
  const value = parseInt(document.getElementById('badgeCountValue').value, 10);

  const data = await apiCall('usersWithAllBadges', {
    minBadges: value,
    mode
  });

  usersByBadgeCountCache = data.users || [];
  renderUserList('usersByBadgeCount', usersByBadgeCountCache);
}

function exportUsersByBadgeCountCSV() {
  if (!usersByBadgeCountCache.length) {
    alert('No users to export');
    return;
  }

  let csv = 'id,username,total_badges,is_banned\n';

  usersByBadgeCountCache.forEach(u => {
    csv += [
      u.id,
      u.x_username,
      u.total_badges ?? '',
      u.is_banned ? 1 : 0
    ].join(',') + '\n';
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = `users_badge_count_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

</script>
</body>
</html>